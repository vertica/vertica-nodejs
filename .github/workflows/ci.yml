name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  workflow_dispatch:

env:
  V_HOST: 127.0.0.1
  V_PORT: 5433
  V_USER: dbadmin
  V_DATABASE: vdb
  KC_REALM: test
  KC_USER: oauth_user
  KC_PASSWORD: password
  KC_CLIENT_ID: vertica
  KC_CLIENT_SECRET: P9f8350QQIUhFfK1GF5sMhq4Dm3P6Sbs

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ['12', '14', '16', '18', '20']
        os: [ubuntu-latest]
    name: Node.js ${{ matrix.node }} (${{ matrix.os }})
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: yarn

      - name: Install dependencies
        run: |
          yarn
          yarn lerna bootstrap

      - name: Create KinD cluster
        uses: helm/kind-action@v1.10.0
        with:
          cluster_name: vertica-ci
          wait: 180s

      - name: Setup Helm
        uses: azure/setup-helm@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Add Helm repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add vertica-charts https://vertica.github.io/charts
          helm repo update

      - name: Create namespace
        run: |
          kubectl create namespace vertica || true

      - name: Install MinIO (communal storage)
        run: |
          cat <<'EOF' | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: minio
            namespace: vertica
            labels:
              app: minio
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: minio
            template:
              metadata:
                labels:
                  app: minio
              spec:
                containers:
                  - name: minio
                    image: minio/minio:latest
                    args: ["server","/data","--address=:9000"]
                    env:
                      - name: MINIO_ROOT_USER
                        value: minio
                      - name: MINIO_ROOT_PASSWORD
                        value: minio123
                    ports:
                      - containerPort: 9000
                        name: api
                    readinessProbe:
                      httpGet:
                        path: /minio/health/ready
                        port: 9000
                      initialDelaySeconds: 5
                      periodSeconds: 5
                    livenessProbe:
                      httpGet:
                        path: /minio/health/live
                        port: 9000
                      initialDelaySeconds: 10
                      periodSeconds: 10
                    volumeMounts:
                      - name: data
                        mountPath: /data
                volumes:
                  - name: data
                    emptyDir: {}
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: minio
            namespace: vertica
            labels:
              app: minio
          spec:
            selector:
              app: minio
            ports:
              - protocol: TCP
                port: 9000
                targetPort: 9000
          EOF

          # Wait for MinIO to be ready
          if ! kubectl wait --for=condition=Ready pod -l app=minio -n vertica --timeout=900s; then
            echo 'MinIO failed to become Ready. Dumping diagnostics...'
            kubectl get pods -n vertica -l app=minio -o wide || true
            kubectl describe pods -n vertica -l app=minio || true
            kubectl logs -n vertica $(kubectl get pods -n vertica -l app=minio -o jsonpath='{.items[0].metadata.name}') || true
            exit 1
          fi
          kubectl get svc -n vertica minio

      - name: Create communal bucket in MinIO
        run: |
          # Create communal bucket using env alias to avoid needing shell
          kubectl run -n vertica mc-mb --image=minio/mc:latest --restart=Never \
            --env MC_HOST_local=http://minio:minio123@minio.vertica.svc.cluster.local:9000 \
            --attach=true --rm -- mc mb -p local/communal || true
          kubectl run -n vertica mc-ls --image=minio/mc:latest --restart=Never \
            --env MC_HOST_local=http://minio:minio123@minio.vertica.svc.cluster.local:9000 \
            --attach=true --rm -- mc ls local

      - name: Create communal credentials secret
        run: |
          kubectl delete secret -n vertica communal-creds --ignore-not-found
          kubectl create secret generic communal-creds -n vertica \
            --from-literal=accessKeyID=minio \
            --from-literal=secretAccessKey=minio123

      - name: Install Vertica Operator
        run: |
          helm upgrade --install vertica-operator vertica-charts/verticadb-operator -n vertica --create-namespace
          kubectl rollout status deploy/verticadb-operator-controller-manager -n vertica --timeout=600s || true
          kubectl get pods -n vertica

      - name: Deploy VerticaDB
        run: |
          cat <<'EOF' | kubectl apply -f -
          apiVersion: vertica.com/v1
          kind: VerticaDB
          metadata:
            name: verticadb-sample
            namespace: vertica
          spec:
            image: opentext/vertica-k8s:latest
            dbName: vdb
            communal:
              path: s3://communal
              credentialSecret: communal-creds
              endpoint: http://minio.vertica.svc.cluster.local:9000
              includeAwsAuth: false
              s3Region: us-east-1
            subclusters:
              - name: defaultsubcluster
                size: 1
          EOF
          # Wait for Vertica server pod to be Ready
          kubectl wait --for=condition=Ready pod -n vertica -l app.kubernetes.io/component=server --timeout=900s
          kubectl get pods -n vertica -o wide

      - name: Install Keycloak
        run: |
          helm upgrade --install keycloak bitnami/keycloak \
            --namespace vertica \
            --set auth.adminUser=admin \
            --set auth.adminPassword=admin
          kubectl wait --for=condition=Ready pod -n vertica -l app.kubernetes.io/name=keycloak --timeout=600s
          kubectl get svc -n vertica keycloak

      - name: Configure Keycloak realm, client, and user
        run: |
          KC_POD=$(kubectl get pods -n vertica -l app.kubernetes.io/name=keycloak -o jsonpath='{.items[0].metadata.name}')
          kubectl exec -n vertica "$KC_POD" -- bash -lc \
            "/opt/bitnami/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080 --realm master --user admin --password admin && \
             /opt/bitnami/keycloak/bin/kcadm.sh create realms -s realm=${KC_REALM} -s enabled=true && \
             /opt/bitnami/keycloak/bin/kcadm.sh update realms/${KC_REALM} -s accessTokenLifespan=3600 && \
             /opt/bitnami/keycloak/bin/kcadm.sh create users -r ${KC_REALM} -s username=${KC_USER} -s enabled=true && \
             /opt/bitnami/keycloak/bin/kcadm.sh set-password -r ${KC_REALM} --username ${KC_USER} --new-password ${KC_PASSWORD} && \
             /opt/bitnami/keycloak/bin/kcadm.sh create clients -r ${KC_REALM} -s clientId=${KC_CLIENT_ID} -s enabled=true -s 'redirectUris=["/*"]' -s 'webOrigins=["/*"]' -s secret=${KC_CLIENT_SECRET} -s directAccessGrantsEnabled=true -o"

      - name: Port-forward services (Vertica 5433 and Keycloak 8080)
        run: |
          # Port-forward Vertica service to localhost:5433
          nohup kubectl port-forward -n vertica svc/verticadb-sample-defaultsubcluster 5433:5433 >/tmp/pf-vertica.log 2>&1 &
          # Port-forward Keycloak service to localhost:8080
          nohup kubectl port-forward -n vertica svc/keycloak 8080:80 >/tmp/pf-keycloak.log 2>&1 &
          sleep 5
          echo "PF logs:" && tail -n +1 /tmp/pf-*.log || true

      - name: Configure Vertica OAuth and create user
        run: |
          V_POD=$(kubectl get pods -n vertica -l app.kubernetes.io/component=server -o jsonpath='{.items[0].metadata.name}')
          DISCOVERY_URL="http://keycloak.vertica.svc.cluster.local/realms/${KC_REALM}/.well-known/openid-configuration"
          INTROSPECT_URL="http://keycloak.vertica.svc.cluster.local/realms/${KC_REALM}/protocol/openid-connect/token/introspect"
          kubectl exec -n vertica "$V_POD" -- bash -lc \
            "/opt/vertica/bin/vsql -c \"CREATE AUTHENTICATION v_oauth METHOD 'oauth' HOST '0.0.0.0/0';\" && \
             /opt/vertica/bin/vsql -c \"ALTER AUTHENTICATION v_oauth SET client_id='${KC_CLIENT_ID}';\" && \
             /opt/vertica/bin/vsql -c \"ALTER AUTHENTICATION v_oauth SET client_secret='${KC_CLIENT_SECRET}';\" && \
             /opt/vertica/bin/vsql -c \"ALTER AUTHENTICATION v_oauth SET discovery_url='${DISCOVERY_URL}';\" && \
             /opt/vertica/bin/vsql -c \"ALTER AUTHENTICATION v_oauth SET introspect_url='${INTROSPECT_URL}';\" && \
             /opt/vertica/bin/vsql -c \"CREATE USER ${KC_USER};\" && \
             /opt/vertica/bin/vsql -c \"GRANT AUTHENTICATION v_oauth TO ${KC_USER};\" && \
             /opt/vertica/bin/vsql -c \"GRANT ALL ON SCHEMA PUBLIC TO ${KC_USER};\" && \
             /opt/vertica/bin/vsql -c \"CREATE AUTHENTICATION v_dbadmin_hash METHOD 'hash' HOST '0.0.0.0/0';\" && \
             /opt/vertica/bin/vsql -c \"ALTER AUTHENTICATION v_dbadmin_hash PRIORITY 10000;\" && \
             /opt/vertica/bin/vsql -c \"GRANT AUTHENTICATION v_dbadmin_hash TO dbadmin;\""

      - name: Retrieve OAuth access token
        run: |
          echo "Waiting for Keycloak to accept connections..." && sleep 5
          curl --retry 10 --retry-delay 3 --retry-all-errors \
            --location --request POST http://127.0.0.1:8080/realms/${KC_REALM}/protocol/openid-connect/token \
            --header 'Content-Type: application/x-www-form-urlencoded' \
            --data-urlencode "username=${KC_USER}" \
            --data-urlencode "password=${KC_PASSWORD}" \
            --data-urlencode "client_id=${KC_CLIENT_ID}" \
            --data-urlencode "client_secret=${KC_CLIENT_SECRET}" \
            --data-urlencode 'grant_type=password' -o oauth.json
          cat oauth.json | python3 -c 'import json,sys;obj=json.load(sys.stdin);print(obj["access_token"])' > access_token.txt
          test -s access_token.txt && echo "Token captured" || (echo "Token missing"; exit 1)

      - name: test-v-connection-string
        run: |
          cd packages/v-connection-string
          yarn test

      - name: test-v-pool
        run: |
          cd packages/v-pool
          yarn test

      - name: test-v-protocol
        run: |
          cd packages/v-protocol
          yarn test

      - name: test-vertica-nodejs
        run: |
          export VTEST_OAUTH_ACCESS_TOKEN="$(cat ${GITHUB_WORKSPACE}/access_token.txt)"
          cd packages/vertica-nodejs
          yarn test
